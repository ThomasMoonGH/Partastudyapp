services:
  redis:
    image: redis:7-alpine
    expose:
      - "6379"
    networks:
      - partastudy
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml --dev
    expose:
      - "7880"
      - "7881"
      - "50000-50100/udp"
    volumes:
      - ./livekit-config.yaml:/etc/livekit.yaml
    depends_on:
      - redis
    networks:
      - partastudy
    restart: unless-stopped

  app:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - /app/node_modules
    expose:
      - "3000"
      - "3001"
    environment:
      - VITE_LIVEKIT_URL=ws://localhost:7880
      - VITE_SUPABASE_URL=https://bkfvtbgalchwoimwtzsu.supabase.co
      - VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrZnZ0YmdhbGNod29pbXd0enN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODgwOTYsImV4cCI6MjA3NjQ2NDA5Nn0.QW9TAXDbPpnutULtCGmSjnM619bP1imq6vSObv6K1nY
    depends_on:
      - livekit
    networks:
      - partastudy
    restart: unless-stopped

  nginx:
    image: nginx:1.27-alpine
    depends_on:
      - app
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot-www:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    networks:
      - partastudy
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    volumes:
      - certbot-www:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    networks:
      - partastudy
    entrypoint: ["/bin/sh", "-c", "trap : TERM INT; sleep infinity & wait"]

networks:
  partastudy:
    driver: bridge

volumes:
  certbot-www:
  certbot-certs:

