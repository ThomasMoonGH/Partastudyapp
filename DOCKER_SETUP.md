# ๐ณ Docker Setup ะดะปั Partastudyapp

## ะัััััะน ััะฐัั

```bash
# 1. ะะปะพะฝะธััะนัะต ัะตะฟะพะทะธัะพัะธะน
git clone <your-repo>
cd Partastudyapp

# 2. ะะปั ะฟัะตะฟัะพะด-ะพะบััะถะตะฝะธั ะทะฐะฟัััะธัะต ะฐะฒัะพะผะฐัะธะทะฐัะธั
scripts/preprod.sh deploy

# 3. ะัะบัะพะนัะต ะฟัะธะปะพะถะตะฝะธะต
open http://localhost:3000
```

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        Docker Compose                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                    โ
โ                          โโโโโโโโโโโโโโโ                           โ
โ           443/80         โ   Nginx     โ                           โ
โ   hochip.ru โโโโโโโโโโโโบ โ (reverse)   โ                           โ
โ                          โโโโโโโโฌโโโโโโโ                           โ
โ                                 โ                                  โ
โ                          โโโโโโโโผโโโโโโโ                           โ
โ                          โ    App      โ                           โ
โ                          โ (Vite:3000) โ                           โ
โ                          โโโโโโโโฌโโโโโโโ                           โ
โ                                 โ                                  โ
โ                   (LiveKit Cloud, Supabase, etc.)                  โ
โ                                                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะกะตัะฒะธัั

### 1. App (Frontend)
- **ะะพัั**: 3000
- **ะขะตัะฝะพะปะพะณะธั**: Vite + React + TypeScript
- **ะะพะผะฐะฝะดะฐ**: `npm run dev -- --host 0.0.0.0`
- **Volumes**: Hot reload ะดะปั ัะฐะทัะฐะฑะพัะบะธ
- **API**: ะฒัะฟะพะผะพะณะฐัะตะปัะฝัะน ัะพะบะตะฝ-ัะตัะฒะตั ะฝะฐ `3001`, ะดะพัััะฟะตะฝ ัะตัะตะท `https://<ะดะพะผะตะฝ>/generate-token` (ะฟัะพะบัะธ nginx)
- **LiveKit URL**: ะฟะพ ัะผะพะปัะฐะฝะธั `wss://<ะดะพะผะตะฝ>/rtc`, ะผะพะถะฝะพ ะฟะตัะตะพะฟัะตะดะตะปะธัั `VITE_LIVEKIT_URL`

### 1a. Nginx (Reverse Proxy)
- **ะะพััั**: 80 (HTTP), 443 (HTTPS)
- **ะะฐะทะฝะฐัะตะฝะธะต**: TLS-ัะตัะผะธะฝะฐัะธั, ะฟัะพะบัะธัะพะฒะฐะฝะธะต ััะฐัะธะบะฐ ะบ `app`
- **ะะพะฝัะธะณ**: `nginx/nginx.conf`
- **Volumes**: ะพะฑัะธะต ั Certbot ะดะปั ัะตััะธัะธะบะฐัะพะฒ ะธ ACME-ัะตะปะปะตะฝะดะถะฐ

### 1b. Certbot (Letโs Encrypt)
- **ะะพััั**: ะธัะฟะพะปัะทัะตััั ะฒัะตะผะตะฝะฝะพ ะฟัะธ ะฒัะฟััะบะต ัะตััะธัะธะบะฐัะพะฒ
- **ะะพะผะฐะฝะดะฐ**: ะทะฐะฟััะบะฐะตััั ะฒัััะฝัั (`docker compose run certbot ...`)
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะฒัะฟััะบ ะธ ะฟัะพะดะปะตะฝะธะต SSL-ัะตััะธัะธะบะฐัะพะฒ ะดะปั `hochip.ru`
- **Volumes**: ะพะฑัะฐั ะฟะฐะฟะบะฐ `/etc/letsencrypt` ะธ webroot `/var/www/certbot`

## HTTPS ะธ Letโs Encrypt

### 1. ะะตัะฒะธัะฝะฐั ะฒัะดะฐัะฐ ัะตััะธัะธะบะฐัะฐ

```bash
# ะฃะฑะตะดะธัะตัั, ััะพ DNS ะดะปั hochip.ru ัะถะต ัะบะฐะทัะฒะฐะตั ะฝะฐ ัะตัะฒะตั.
# ะะตัะตะด ะทะฐะฟััะบะพะผ nginx ะฟะพะปััะธัะต ัะตััะธัะธะบะฐั (ะฟะพัั 80/443 ะดะพะปะถะตะฝ ะฑััั ัะฒะพะฑะพะดะตะฝ).

docker compose run --rm \
  -p 80:80 -p 443:443 \
  certbot certonly --standalone \
  -d hochip.ru \
  --agree-tos \
  --no-eff-email \
  -m you@example.com

# ะะพัะปะต ััะฟะตัะฝะพะณะพ ะฒัะฟััะบะฐ ะฟะตัะตะทะฐะฟัััะธัะต ััะตะบ
docker compose up -d nginx app
```

Certbot ัะพััะฐะฝะธั ัะตััะธัะธะบะฐัั ะธ ะฒัะฟะพะผะพะณะฐัะตะปัะฝัะต ัะฐะนะปั (`options-ssl-nginx.conf`, `ssl-dhparams.pem`) ะฒ volume `certbot-certs`, ะบะพัะพััะน ะธัะฟะพะปัะทัะตััั nginx-ะพะผ.

ะัะปะธ ะฟะพัะปะต ะฒัะฟััะบะฐ nginx ะฟะธัะตั `open() "/etc/letsencrypt/options-ssl-nginx.conf" failed`, ะทะฐะฟัััะธัะต `scripts/preprod.sh deploy` ะตัั ัะฐะท โ ัะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะบะพะฟะธััะตั ะดะตัะพะปัะฝัะต `options-ssl-nginx.conf` ะธ `ssl-dhparams.pem` ะธะท ะพะฑัะฐะทะฐ Certbot ะฒ ัะพะผ.

### 2. ะัะพะดะปะตะฝะธะต ัะตััะธัะธะบะฐัะฐ

```bash
# ะััะฐะฝะพะฒะธัั ะฝะตะพะฑัะทะฐัะตะปัะฝะพ โ challenge ะพะฑัะปัะถะธั nginx ัะตัะตะท webroot
docker compose run --rm certbot renew --webroot -w /var/www/certbot

# ะะพัะปะต ะฟัะพะดะปะตะฝะธั ะฟะตัะตะทะฐะณััะทะธัะต nginx, ััะพะฑั ะพะฝ ะฟะตัะตัะธัะฐะป ะบะปััะธ
docker compose exec nginx nginx -s reload
```

ะะพะฑะฐะฒััะต cron/systemd ัะฐะนะผะตั, ะบะพัะพััะน ะฑัะดะตั ะฒัะทัะฒะฐัั ะบะพะผะฐะฝะดั ะฟัะพะดะปะตะฝะธั ัะฐะท ะฒ ะดะตะฝั. Certbot ะพะฑะฝะพะฒะปัะตั ัะตััะธัะธะบะฐั ะฟัะธ ะพััะฐัะพัะฝะพะผ ััะพะบะต <30 ะดะฝะตะน.

### 3. ะกะบัะธะฟั `scripts/preprod.sh`

ะะฒัะพะผะฐัะธะทะธััะตั ะฟะพะดะณะพัะพะฒะบั ะฟัะตะฟัะพะด-ะพะบััะถะตะฝะธั:
- `deploy` โ ะฟัะพะฒะตััะตั/ะฒัะฟััะบะฐะตั ัะตััะธัะธะบะฐั (ะธัะฟะพะปัะทัะตั `LETSENCRYPT_EMAIL`), ัะพะฑะธัะฐะตั `app`, ะทะฐะฟััะบะฐะตั `app` ะธ `nginx`, ะฟัะพะบะธะดัะฒะฐะตั ะฟะตัะตะผะตะฝะฝัะต ะดะปั LiveKit Cloud.
- `renew` โ ะฒัะฟะพะปะฝัะตั `certbot renew` ะธ ะฟะตัะตะทะฐะณััะถะฐะตั `nginx`.
- `issue` โ ะฟัะธะฝัะดะธัะตะปัะฝะฐั ะฝะฐัะฐะปัะฝะฐั ะฒัะดะฐัะฐ ัะตััะธัะธะบะฐัะฐ (ะตัะปะธ ัะพะผ ะฟัััะพะน).

ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:
- `DOMAIN` (ะฟะพ ัะผะพะปัะฐะฝะธั `hochip.ru`)
- `LETSENCRYPT_EMAIL` โ email ะพะฑัะทะฐัะตะปัะฝัะน ะดะปั ะฟะตัะฒะพะณะพ ะฒัะฟััะบะฐ.
- `LIVEKIT_API_KEY` / `LIVEKIT_API_SECRET` โ ะบัะตะดั LiveKit Cloud.
- `LIVEKIT_HOST` โ URL ะพะฑะปะฐัะฝะพะณะพ LiveKit (`wss://partastudyapp-3jhslurr.livekit.cloud` ะฟะพ ัะผะพะปัะฐะฝะธั).

## ะะพะผะฐะฝะดั

### ะัะฝะพะฒะฝัะต ะบะพะผะฐะฝะดั

```bash
# ะะฐะฟััะบ ะฒัะตั ัะตัะฒะธัะพะฒ
docker-compose up -d

# ะัะพัะผะพัั ะปะพะณะพะฒ
docker-compose logs -f

# ะัะพัะผะพัั ะปะพะณะพะฒ ะบะพะฝะบัะตัะฝะพะณะพ ัะตัะฒะธัะฐ
docker-compose logs -f app

# ะะพะณะธ nginx
docker compose logs -f nginx

# ะััะฐะฝะพะฒะบะฐ ะฒัะตั ัะตัะฒะธัะพะฒ
docker-compose down

# ะะตัะตะทะฐะฟััะบ ัะตัะฒะธัะฐ
docker-compose restart app

# ะะตัะตัะฑะพัะบะฐ ะธ ะทะฐะฟััะบ
docker-compose up --build -d
```

### ะัะปะฐะดะบะฐ

```bash
# ะัะพะฒะตัะธัั ััะฐััั ัะตัะฒะธัะพะฒ
docker-compose ps

# ะะพะนัะธ ะฒ ะบะพะฝัะตะนะฝะตั
docker-compose exec app sh

# ะัะพะฒะตัะธัั ัะตัั
docker network ls
docker network inspect partastudyapp_partastudy
```

## ะะพะฝัะธะณััะฐัะธั

### Environment Variables

ะกะพะทะดะฐะนัะต `.env.development`:
```bash
VITE_LIVEKIT_URL=wss://partastudyapp-3jhslurr.livekit.cloud
VITE_SUPABASE_URL=https://bkfvtbgalchwoimwtzsu.supabase.co
VITE_SUPABASE_ANON_KEY=your_key_here
# ะะฟัะธะพะฝะฐะปัะฝะพ: ะฟะตัะตะพะฟัะตะดะตะปะตะฝะธะต ัะฝะดะฟะพะธะฝัะฐ ัะพะบะตะฝ-ัะตัะฒะตัะฐ
# VITE_TOKEN_ENDPOINT=/generate-token
# ะะปั ะฟัะตะฟัะพะดะฐ: VITE_LIVEKIT_URL=wss://partastudyapp-3jhslurr.livekit.cloud
```

### LiveKit Cloud Secrets

ะะปั ะปะพะบะฐะปัะฝะพะณะพ ะทะฐะฟััะบะฐ ะทะฐะดะฐะนัะต:

```bash
export LIVEKIT_API_KEY=your_cloud_key
export LIVEKIT_API_SECRET=your_cloud_secret
export LIVEKIT_HOST=wss://partastudyapp-3jhslurr.livekit.cloud
```

ะญัะธ ะฟะตัะตะผะตะฝะฝัะต ะฝัะถะฝั ัะพะบะตะฝ-ัะตัะฒะตัั (`token-server.js`) ะธ Supabase Edge Function.

## Troubleshooting

### ะัะพะฑะปะตะผะฐ: App ะฝะต ะทะฐะฟััะบะฐะตััั

```bash
# ะัะพะฒะตัะธัั ะปะพะณะธ
docker-compose logs app

# ะะตัะตัะพะฑัะฐัั ะบะพะฝัะตะนะฝะตั
docker-compose up --build app
```

### ะัะพะฑะปะตะผะฐ: ะะธะดะตะพ ะฝะต ัะฐะฑะพัะฐะตั

1. **ะัะพะฒะตัััะต HTTPS**: ะัะฐัะทะตัั ััะตะฑััั HTTPS ะดะปั ะดะพัััะฟะฐ ะบ ะบะฐะผะตัะต
2. **ะัะพะฒะตัััะต ัะฐะทัะตัะตะฝะธั**: ะะฐะทัะตัะธัะต ะดะพัััะฟ ะบ ะบะฐะผะตัะต/ะผะธะบัะพัะพะฝั
3. **ะัะพะฒะตัััะต ะบะพะฝัะพะปั**: F12 โ Console ะฝะฐ ะพัะธะฑะบะธ

### ะัะพะฑะปะตะผะฐ: ะะพััั ะทะฐะฝััั

```bash
# ะะฐะนัะธ ะฟัะพัะตัั ะฝะฐ ะฟะพััั
lsof -i :3000

# ะฃะฑะธัั ะฟัะพัะตัั
kill -9 <PID>
```

## Production Deployment

### ะะปั Beget VPS

1. **ะกะพะทะดะฐะนัะต `.env.production`**:
```bash
VITE_LIVEKIT_URL=wss://partastudyapp-3jhslurr.livekit.cloud
VITE_SUPABASE_URL=https://bkfvtbgalchwoimwtzsu.supabase.co
VITE_SUPABASE_ANON_KEY=your_key_here
```

2. **ะัะฟะพะปัะทัะนัะต `docker-compose.production.yml`** (ะฑัะดะตั ัะพะทะดะฐะฝ ะฟะพะทะถะต)

3. **ะะฐัััะพะนัะต Nginx** ะดะปั HTTPS ะธ WebSocket ะฟัะพะบัะธัะพะฒะฐะฝะธั

## ะัะพะฒะตัะบะฐ HTTPS

1. **ะัะพะฒะตัะบะฐ ะบะพะฝัะธะณััะฐัะธะธ nginx**
   ```bash
   docker compose exec nginx nginx -t
   ```
2. **ะัะพะฒะตัะบะฐ HTTPโHTTPS ัะตะดะธัะตะบัะฐ**
   ```bash
   curl -I http://hochip.ru
   ```
3. **ะัะพะฒะตัะบะฐ ัะตััะธัะธะบะฐัะฐ ะธ ัะพัั-ัะตะดะตัะฐ**
   ```bash
   curl -I https://hochip.ru
   ```
   ะฃะฑะตะดะธัะตัั, ััะพ ััะฐััั 200/302, ะฐ ะฒ ะพัะฒะตัะต ะฝะตั `Blocked host`.
4. **ะัะพะฒะตัะบะฐ WebSocket ะฟัะพะบัะธัะพะฒะฐะฝะธั** (ะดะพะปะถะฝะพ ะฒะตัะฝััั 101)
   ```bash
   curl -i -H "Upgrade: websocket" -H "Connection: Upgrade" \
     -H "Host: hochip.ru" \
     http://localhost:80
   ```
5. **ะัะพะฒะตัะบะฐ ัะฒัะทะฝะพััะธ ะฒะฝัััะธ ัะตัะธ**
   ```bash
   docker compose exec nginx curl -I http://app:3000
   ```
   ะัะฒะตั 200/302 ะฟะพะดัะฒะตัะถะดะฐะตั, ััะพ proxy ะฒะธะดะธั dev-ัะตัะฒะตั Vite ะฒะฝัััะธ ัะตัะธ Docker.
6. **ะะตัะธัะธะบะฐัะธั LiveKit** (ะตัะปะธ ััะตะฑัะตััั ะฒะฝะตัะฝะธะน ะดะพัััะฟ)
   ```bash
   curl https://hochip.ru:443/.well-known/acme-challenge/test --silent --show-error
   ```
   ะะพ ะฟัะพะดะปะตะฝะธั ัะฑะตะดะธัะตัั, ััะพ ัะฐะนะป ะธะท `/var/www/certbot` ะพัะดะฐัััั.

## ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั

```bash
# ะัะธััะบะฐ Docker
docker system prune -f
docker volume prune -f

# ะัะพัะผะพัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะตััััะพะฒ
docker stats
```

## ะะพะฝะธัะพัะธะฝะณ

### Health Checks

```bash
# App health
curl http://localhost:3000
```

### ะะพะณะธ

```bash
# ะัะต ะปะพะณะธ
docker-compose logs --tail=100

# ะขะพะปัะบะพ ะพัะธะฑะบะธ
docker-compose logs | grep -i error

# ะะพะณะธ nginx
docker compose logs --tail=100 nginx
```

---

**ะะพัะพะฒะพ!** ะขะตะฟะตัั ั ะฒะฐั ะตััั Docker-ะธะฝััะฐััััะบัััะฐ ะดะปั ะฟัะธะปะพะถะตะฝะธั PartaStudy ั ะฒะฝะตัะฝะธะผ LiveKit Cloud! ๐
