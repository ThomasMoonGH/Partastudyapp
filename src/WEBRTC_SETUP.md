# Настройка WebRTC видео-связи в PARTA

## Что реализовано

Теперь приложение PARTA поддерживает **настоящую видео и аудио связь** между участниками через технологию WebRTC (Web Real-Time Communication). Это означает, что когда два пользователя присоединяются к одной сессии, они могут реально видеть и слышать друг друга.

## Как это работает

### Технология
- **WebRTC**: Peer-to-peer соединение напрямую между браузерами участников
- **Сигнальный сервер**: Supabase Edge Functions координируют установку соединения
- **STUN серверы**: Используются Google STUN серверы для преодоления NAT

### Процесс подключения
1. Пользователь присоединяется к сессии
2. Запрашивается доступ к микрофону/камере
3. Участники обмениваются сигналами через сервер (SDP, ICE candidates)
4. Устанавливается прямое peer-to-peer соединение
5. Аудио и видео потоки передаются напрямую между браузерами

## Использование

### Разрешения браузера
Для использования голосового/видео общения нужно разрешить доступ к устройствам:

1. **При входе в сессию** увидите синюю панель с кнопкой "Разрешить доступ к микрофону"
2. **Нажмите кнопку** - браузер запросит разрешение
3. **Разрешите доступ** к микрофону (обязательно для общения)
4. **Камера** - опционально, можно включить позже кнопкой видео

⚠️ **Важно**: 
- Без разрешения микрофона голосовое общение невозможно
- Вы всё ещё можете использовать текстовый чат
- Если случайно отклонили - обновите страницу и попробуйте снова

### Управление во время сессии
- **Кнопка видео**: Включить/выключить камеру (можно работать без видео)
- **Кнопка микрофона**: Включить/выключить звук
- **Индикатор состояния**: Показывает статус подключения (connecting, connected)

### Требования к браузеру
WebRTC поддерживается всеми современными браузерами:
- ✅ Chrome/Edge (рекомендуется)
- ✅ Firefox
- ✅ Safari (macOS/iOS)
- ✅ Opera

## Часто задаваемые вопросы

Подробное руководство по решению проблем см. в **[WEBRTC_FAQ.md](./WEBRTC_FAQ.md)**

Там вы найдёте ответы на вопросы:
- Как включить микрофон?
- Что делать, если отклонил разрешение?
- Почему не слышу партнёра?
- Работает ли на телефоне?
- И многое другое!

## Технические детали

### Архитектура
```
Пользователь A (браузер)
    ↓ (сигнализация через сервер)
Supabase Edge Functions
    ↓ (сигнализация через сервер)
Пользователь B (браузер)
    ← → (прямое P2P соединение для медиа)
```

### Файлы
- `/utils/webrtc.ts` - Класс для управления WebRTC соединением
- `/utils/useWebRTC.ts` - React хук для интеграции в компоненты
- `/components/ActiveSession.tsx` - Компонент сессии с видео
- `/supabase/functions/server/index.tsx` - Сигнальные маршруты

### API маршруты
Серверная часть предоставляет следующие маршруты для сигнализации:
- `POST /webrtc/join-session` - Присоединиться к сессии
- `POST /webrtc/offer` - Отправить WebRTC offer
- `GET /webrtc/offer/:sessionId/:from/:to` - Получить offer
- `POST /webrtc/answer` - Отправить WebRTC answer
- `GET /webrtc/answer/:sessionId/:from/:to` - Получить answer
- `POST /webrtc/ice-candidate` - Отправить ICE candidate
- `GET /webrtc/ice-candidates/:sessionId/:from/:to` - Получить ICE candidates
- `POST /webrtc/leave-session` - Покинуть сессию

## Отладка

### Проблемы с подключением
Если видео/аудио не работает:

1. **Проверьте разрешения браузера**
   - Откройте настройки браузера
   - Убедитесь, что сайт имеет доступ к микрофону/камере

2. **Проверьте консоль браузера** (F12)
   - Ищите сообщения WebRTC
   - Проверьте состояние соединения (connectionState)

3. **Проверьте индикаторы**
   - Статус "connecting" → "connected" означает успешное соединение
   - Зелёные значки микрофона показывают активное аудио

4. **Брандмауэр/Корпоративная сеть**
   - Некоторые корпоративные сети блокируют WebRTC
   - Попробуйте из другой сети (домашний WiFi, мобильный интернет)

### Логирование
Все события WebRTC логируются в консоль браузера:
```
Initializing WebRTC connection...
Local stream started: { video: false, audio: true }
Created offer
Received answer
Connection state: connected
```

## Улучшения в будущем

Возможные дополнения:
- [ ] Видео в высоком качестве (HD)
- [ ] Screen sharing (демонстрация экрана)
- [ ] Запись сессий
- [ ] Групповые сессии (более 2 участников)
- [ ] TURN сервер для сложных сетевых конфигураций
- [ ] Индикатор качества соединения
- [ ] Автоматическое переподключение при разрыве

## Безопасность

- ✅ Все медиа-потоки передаются по зашифрованному DTLS (аналог TLS для UDP)
- ✅ Соединение peer-to-peer (сервер не видит контент)
- ✅ Доступ к камере/микрофону требует явного разрешения пользователя
- ✅ Потоки автоматически останавливаются при завершении сессии
